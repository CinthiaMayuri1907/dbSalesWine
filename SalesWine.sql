--Usar Master
use master;
go

--Eliminar base de datos
DROP DATABASE  IF EXISTS  dbSalesWine;
go

--Crear base de datos dbSalesWine
Create database dbSalesWine;
go

--Usar la base de datos dbSalesWine
use dbSalesWine;
go 


--TABLA PERSONA 
DROP TABLE if EXISTS PERSONA;
create table PERSONA
(	
	IDPER INT IDENTITY(100,1)PRIMARY KEY,
	DNIPER CHAR(8) UNIQUE CHECK(DNIPER LIKE '%[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]%'),
	APEPER VARCHAR(80) CHECK(APEPER LIKE '%[a-zA-Z ]%'),--VALIDACION SOLO LETRAS, ESPACIO Y CARACTERES ESPECIALES
	NOMPER VARCHAR(80) CHECK(NOMPER LIKE '%[A-z_ñ_á_é_í_ó_ú_Á_É_Í_Ó_Ú_\s]%'),--VALIDACION SOLO LETRAS, ESPACIO Y CARACTERES ESPECIALES
	CELPER CHAR(9)UNIQUE CHECK(CELPER LIKE '%[9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]%'),
	EMAPER VARCHAR(150) UNIQUE ,
	FECNACPER DATE CHECK (YEAR(GETDATE())-YEAR(FECNACPER) >= 18), 
	TIPPER CHAR(1) CHECK(TIPPER='C' OR TIPPER='V' OR TIPPER='J')
)
GO

--TABLA PRODUCTO
DROP TABLE if EXISTS PRODUCTO;
create table PRODUCTO
(
	CODPRO CHAR(3) PRIMARY KEY CHECK(CODPRO LIKE '[P][0-9][0-9]'),
	NOMPRO VARCHAR(80),
	TIPPRO CHAR(1) CHECK(TIPPRO='V' OR TIPPRO='T' OR TIPPRO='P' OR TIPPRO='W'),--VALIDACION SOLO CIERTOS CARACTERES V,T,P y W
	VOLPRO CHAR(3) CHECK(VOLPRO='250' OR VOLPRO='500' OR VOLPRO='750') ,--VALIDACION SOLO CIERTOS VALORES
	PAISPRO CHAR(1) CHECK(PAISPRO='P' OR PAISPRO='A' OR PAISPRO='C' OR PAISPRO='E'  OR PAISPRO='M') ,--VALIDACION SOLO CIERTOS CARACTERES
	PREPRO DECIMAL(8,2),
	STOCKPRO INT,
	ESTPRO CHAR(1) DEFAULT 'A' CHECK(ESTPRO='A' OR ESTPRO='I'),
)
GO

--TABLA VENTA
DROP TABLE if EXISTS VENTA;
create table VENTA
(
	IDVEN INT IDENTITY(1,1) PRIMARY KEY,
	FECVENT DATETIME DEFAULT GETDATE(), 
	IDVEND INT FOREIGN KEY REFERENCES PERSONA(IDPER),
	IDCLI INT FOREIGN KEY REFERENCES PERSONA(IDPER),
	TIPPAGVEN CHAR(1) CHECK(TIPPAGVEN='E' OR TIPPAGVEN='T' OR TIPPAGVEN='Y' OR TIPPAGVEN='P'),--VAL
	TIPENTVEN CHAR(1) CHECK(TIPENTVEN='D' OR TIPENTVEN='T') ,
	ESTVENT CHAR(1) DEFAULT 'A' CHECK(ESTVENT='A'  OR ESTVENT='I') 
)
GO 

--TABLA VENTA DETALLE
DROP TABLE if EXISTS VENTA_DETALLE;
create table VENTA_DETALLE
(
	IDVENDET INT IDENTITY(1,1) PRIMARY KEY,
	IDVEN INT FOREIGN KEY REFERENCES VENTA(IDVEN),
	CODPRO CHAR(3) FOREIGN KEY REFERENCES PRODUCTO(CODPRO),
	CANVENDET INT,
)
GO

-- Relacion entre PERSONA VENDEDOR y VENTA

ALTER TABLE VENTA 
ADD CONSTRAINT VENTA_VENDEDOR FOREIGN KEY (IDVEND) 
REFERENCES PERSONA (IDPER)   
GO

-- Relacion entre PERSONA CLIENTE y VENTA

ALTER TABLE VENTA 
ADD CONSTRAINT VENTA_CLIENTE FOREIGN KEY (IDCLI) 
REFERENCES PERSONA (IDPER)   
GO	

-- Relacion entre VENTA y VENTA_DETALLE  

ALTER TABLE VENTA_DETALLE 
ADD CONSTRAINT VENTA_DETALLE_VENTA FOREIGN KEY (IDVEN) 
REFERENCES VENTA (IDVEN)   
GO

-- Relacion entre PRODUCTO y VENTA_DETALLE 

ALTER TABLE VENTA_DETALLE 
ADD CONSTRAINT VENTA_DETALLE_PRODUCTO FOREIGN KEY (CODPRO) 
REFERENCES PRODUCTO (CODPRO)   
GO		

--REGISTRO DE PERSONA


SET DATEFORMAT dmy

INSERT INTO PERSONA
(DNIPER, APEPER, NOMPER,CELPER,	EMAPER,	FECNACPER,TIPPER)
VALUES
('15288111','VAQUEZ CARRANZA','Adriana', '991548789', 'adriana.vasquez@saleswine.com', '10/03/1985','V'),
('45781236','GUERRA TASAYCO','Carlos','987845123', 'carlos.guerra@saleswine.com', '20/10/1980', 'J'),
('15263698','LOMBARDI PEREZ','Daniel', '998523641' , 'daniel.lombardi@saleswine.com' , '06/06/1982', 'J'),
('45123698','PALACIOS CASTILLO','Roberto', '985236417','roberto.palacios@saleswine.com' ,'15/10/1988', 'V'),
('15264477','PALOMINO FERNANDEZ','Carlos','984512557','carlos.palomino@saleswine.com','30/01/1989','V'),
('45127866','ROSALES ZEGARRA','Fabricio','974815231','fabricio@yahoo.com','02/03/1975','C'),
('15487865','DAVILA SANCHEZ','Rosaura','974815254','rosaurao@gmail.com','16/06/1979','C'),
('46632157','JUAREZ MARTINEZ','Noemi','984525741','noemi.juarez@gmail.com','25/09/1979','C'),
('47258533','SANCHEZ JOBS', 'Issac','953625147','issac.sanchez@outlook.com','30/10/1995','C'),
('15258544','CARRIZALES CAMPOS', 'Fabiana','951144236','fabiana.carrizales@outlook.com','05/04/1997','C'),
('44712214','MENDOZA SOLANO', 'Valeria','972544681','valeria.mendoza@yahoo.com','06/06/1997','C')
go


INSERT INTO PRODUCTO 
(CODPRO	,NOMPRO	,TIPPRO ,VOLPRO ,PAISPRO, PREPRO, STOCKPRO)
VALUES
('P01','Ramos Pinto Porto','V','750','P','119.20','60'),
('P02','Santa Julia Cabernet','V','750','A','119.20','45'),
('P03','Pulenta Estate Cabernet Sauvignon','V','750','A','189.90','70'),
('P04','La Rioja Alta Via Alberdi','V','500','E','540.00','80'),
('P05','Amayna Pinot Noir','V','750','C','774.20','100'),
('P06','Pisco Don Santiago Mosto Verde Italia','P','750','P','59.00','75'),
('P07','Pisco Portón Mosto Verde Torontel','P','750','P','89.00','100'),
('P08','Tequila Olmeca Blanco','T','500','M','54.90','85'),
('P09','Tequila Olmeca Reposado','T','750','M','54.90','85'),
('P10','Black Whiskey Don Michael','W','750','P','159.90','70'),
('P11','Whisky Chivas Regal 12 Años','W','500','E','89.90','70')
GO



INSERT INTO VENTA
(IDVEND,IDCLI,TIPPAGVEN,TIPENTVEN)
VALUES
('100','105','E','D'),
('103','107','T','T'),
('104','110','Y','D'),
('100','106','Y','T'),
('103','105','E','T'),
('100','109','P','T'),
('100','108','T','T')
GO


INSERT INTO VENTA_DETALLE
(IDVEN,CODPRO,CANVENDET)
VALUES
('1','P01','5'),
('1','P06','2'),
('2','P01','2'),
('3','P05','6'),
('3','P02','10'),
('3','P03','15'),
('3','P04','8'),
('4','P07','6'),
('4','P01','12'),
('4','P03','8'),
('4','P06','7'),
('5','P08','6'),
('5','P10','12'),
('5','P04','8'),
('6','P02','4'),
('6','P11','10'),
('6','P03','2'),
('7','P04','6'),
('7','P02','3'),
('7','P06','1')
GO

--CONSULTAS A DBSALESWINE
--2 
SELECT 
	IDPER  AS ID,
    DNIPER AS 'DNI',
    [APEPER] +', '+ [NOMPER] AS 'PERSONA',
	CELPER AS CELULAR,
	EMAPER AS 'EMAIL',
    FORMAT(FECNACPER, 'dd-MMM-yy') AS 'FECHA NACIMIENTO',
	CASE TIPPER 
		WHEN 'V' THEN 'Vendedor' 
		WHEN 'J' THEN 'Jefe'
		WHEN 'C' THEN 'Cliente'
	END AS 'Tipo'
FROM PERSONA 
GO
--3
SELECT
CODPRO AS CODIGO,
NOMPRO AS PRODUCTO,
CASE TIPPRO
	WHEN 'V' THEN 'VINO'	
	WHEN 'P' THEN 'PISCO'
	WHEN 'T' THEN 'TEQUILA'
	WHEN 'W' THEN 'WHISKY'
	END AS 'PRODUCTO',
CONCAT(VOLPRO,' ml.') AS VOLUMEN,
CASE PAISPRO 
	WHEN 'P' THEN 'Perú'
	WHEN 'A' THEN 'Argentina'
	WHEN 'C' THEN 'Chile'
	WHEN 'E' THEN 'España'
	WHEN 'M' THEN 'México'
	END AS PAIS,
CONCAT('S/',PRODUCTO.PREPRO) AS PRECIO,
STOCKPRO AS STOCK,
CASE ESTPRO 
	WHEN 'A' THEN 'Activo'
	WHEN 'I' THEN 'Inactivo'
END AS ESTADO
FROM PRODUCTO

--4
SELECT 
VENTA.IDVEN AS VENTA,
FORMAT(FECVENT, 'dd-MM-yy - HH.MM') AS 'FEC.VENTA',
CONCAT (UPPER (VENDEDOR.APEPER), ', ',VENDEDOR.NOMPER) AS VENDEDOR,
CONCAT (UPPER (CLIENTE.APEPER), ', ',CLIENTE.NOMPER) AS CLIENTE,
CASE VENTA.TIPPAGVEN
	WHEN 'E' THEN 'EFECTIVO'
	WHEN 'T' THEN 'TARJETA'
	WHEN 'Y' THEN 'YAPE'
	WHEN 'P' THEN 'PLIN'
END AS 'TIPO PAGO',
CASE VENTA.TIPENTVEN 
	WHEN 'D' THEN 'Delivery'
	WHEN 'T' THEN 'Tienda'
END AS 'TIPO ENTREGA',
CASE VENTA.ESTVENT 
	WHEN 'A' THEN 'Activo'
	WHEN 'I' THEN 'Inactivo'
END AS 'EST.VENTA'
FROM VENTA 
INNER JOIN PERSONA VENDEDOR ON VENTA.IDVEND = VENDEDOR.IDPER
INNER JOIN PERSONA CLIENTE ON VENTA.IDCLI = CLIENTE.IDPER;
--5
SELECT 
    IDVENDET AS 'ID DETALLE',
    IDVEN AS 'ID VENTA',
    NOMPRO AS 'PRODUCTO',
    CANVENDET AS 'CANTIDAD'
FROM VENTA_DETALLE
INNER JOIN PRODUCTO ON VENTA_DETALLE.CODPRO = PRODUCTO.CODPRO
GO
--6
SELECT 
  CONSTRAINT_NAME as 'Constraint',
  TABLE_NAME as 'Tabla'
  --REFERENCED_TABLE_NAME as 'Tabla'                  
FROM
  INFORMATION_SCHEMA.KEY_COLUMN_USAGE  
WHERE
  TABLE_SCHEMA = SCHEMA_NAME() 
  GO

 
  
SELECT *FROM PERSONA;
SELECT * FROM PRODUCTO;
SELECT * FROM VENTA;
SELECT * FROM VENTA_DETALLE;